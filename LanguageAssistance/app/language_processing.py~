import re
from transformers import pipeline

# Düzeltme modelini bir kez yükle
grammar_corrector = pipeline(
    "text2text-generation",
    model="prithivida/grammar_error_correcter_v1",
    tokenizer="prithivida/grammar_error_correcter_v1"
)


def get_corrected_sentence(user_sentence: str) -> str:
    """
    Kullanıcının cümlesini dil bilgisi ve yazım açısından düzeltir.
    """
    try:
        # Cümlenin sonuna bir nokta eklemek, modelin daha iyi çalışmasını sağlar.
        if not user_sentence.strip().endswith('.'):
            user_sentence += '.'

        corrected = grammar_corrector(
            user_sentence,
            max_length=64,
            clean_up_tokenization_spaces=True
        )[0]["generated_text"].strip()

        # Gereksiz tekrarları ve anlamsız çıktıları temizle
        if len(corrected.split()) > len(user_sentence.split()) * 2:
            return user_sentence  # Düzeltme anlamsızsa orijinalini geri ver.

        return corrected
    except Exception as e:
        print(f"Düzeltme hatası: {e}")
        return user_sentence


def get_correction_details(original: str, corrected: str) -> list:
    """
    Orijinal ve düzeltilmiş cümleler arasındaki farkları bulur.
    """
    details = []

    # Noktalama işaretlerini ve birden fazla boşluğu temizle
    original_clean = re.sub(r'[,.?!]', '', original).lower().split()
    corrected_clean = re.sub(r'[,.?!]', '', corrected).lower().split()

    for i in range(min(len(original_clean), len(corrected_clean))):
        orig_word = original_clean[i]
        corr_word = corrected_clean[i]

        if orig_word != corr_word:
            # Yaygın yazım hataları için özel kontrol
            if len(orig_word) == len(corr_word) and sum(1 for a, b in zip(orig_word, corr_word) if a != b) <= 1:
                details.append(f"Yazım hatası: '{orig_word}' yerine '{corr_word}' demek mi istediniz?")
            else:
                details.append(f"Düzeltme: '{orig_word}' kelimesi '{corr_word}' olarak değiştirildi.")

    return details


# Sadece kelime listesi için bu değişkeni yeni dosyaya taşıdım
VOCAB = [
    {"word": "merhaba", "meaning": "hello, hi", "examples": ["Merhaba! Nasılsın?", "Merhaba, adın ne?"]},
    {"word": "kitap", "meaning": "book", "examples": ["Bu kitap çok ilginç.", "Okumak için bir kitap aldım."]},
    {"word": "ev", "meaning": "house, home", "examples": ["Evimiz büyük ve güzel.", "Akşamları evde dinleniyorum."]}
]
